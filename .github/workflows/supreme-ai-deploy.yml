name: Reusable Supreme AI Deploy

on:
  workflow_call:
    inputs:
      node-version:
        description: Node.js version used during validation
        required: false
        default: '20'
        type: string
      app-port:
        description: Container application port
        required: false
        default: 3000
        type: number
      host-port:
        description: Host port exposed on the deploy server
        required: false
        default: 80
        type: number
      bind-ip:
        description: Bind address on deploy host (127.0.0.1 recommended)
        required: false
        default: '127.0.0.1'
        type: string
      healthcheck-url:
        description: Health endpoint URL checked from deploy host
        required: false
        default: 'http://localhost/health'
        type: string
    secrets:
      DEPLOY_HOST:
        required: true
      DEPLOY_USER:
        required: true
      DEPLOY_SSH_KEY:
        required: true
      GHCR_USERNAME:
        required: true
      GHCR_TOKEN:
        required: true

  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: supreme-ai-deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  CONTAINER_NAME: supreme-ai-hub

jobs:
  validate:
    name: Validate, test, and build
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version || '20' }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint --if-present

      - name: Unit tests
        run: npm test --if-present -- --ci

      - name: Build
        run: npm run build --if-present

  containerize:
    name: Build and push image
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.vars.outputs.image_tag }}
      image_repo: ${{ steps.vars.outputs.image_repo }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image variables
        id: vars
        run: |
          IMAGE_REPO=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
          echo "image_repo=${IMAGE_REPO}" >> "$GITHUB_OUTPUT"
          echo "image_tag=sha-${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.vars.outputs.image_repo }}
          tags: |
            type=raw,value=${{ steps.vars.outputs.image_tag }}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    name: Deploy to server
    runs-on: ubuntu-latest
    needs: containerize
    timeout-minutes: 20
    environment:
      name: production

    steps:
      - name: Deploy and verify
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_REPO: ${{ needs.containerize.outputs.image_repo }}
          IMAGE_TAG: ${{ needs.containerize.outputs.image_tag }}
          GHCR_USER: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          HEALTHCHECK_URL: ${{ inputs.healthcheck-url || 'http://localhost/health' }}
          DEPLOY_BIND_IP: ${{ inputs.bind-ip || '127.0.0.1' }}
          APP_PORT: ${{ inputs.app-port || 3000 }}
          HOST_PORT: ${{ inputs.host-port || 80 }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script_stop: true
          envs: IMAGE_REPO,IMAGE_TAG,GHCR_USER,GHCR_TOKEN,HEALTHCHECK_URL,DEPLOY_BIND_IP,APP_PORT,HOST_PORT
          script: |
            set -euxo pipefail
            IMAGE="${{ env.REGISTRY }}/${IMAGE_REPO}:${IMAGE_TAG}"

            printf '%s' "$GHCR_TOKEN" | docker login ${{ env.REGISTRY }} -u "$GHCR_USER" --password-stdin
            docker pull "$IMAGE"

            docker stop "${{ env.CONTAINER_NAME }}" || true
            docker rm "${{ env.CONTAINER_NAME }}" || true

            docker run -d --name "${{ env.CONTAINER_NAME }}" --restart unless-stopped \
              -p ${DEPLOY_BIND_IP}:${HOST_PORT}:${APP_PORT} \
              "$IMAGE"

            for attempt in {1..12}; do
              if curl -fsS "$HEALTHCHECK_URL" > /dev/null; then
                echo "Health check passed on attempt ${attempt}"
                docker image prune -f || true
                exit 0
              fi
              sleep 5
            done

            echo "Health check failed for ${HEALTHCHECK_URL}" >&2
            docker logs --tail 100 "${{ env.CONTAINER_NAME }}" || true
            exit 1
