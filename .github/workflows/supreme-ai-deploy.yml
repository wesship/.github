name: Supreme AI Deployment Hub CI/CD

on:
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  CONTAINER_NAME: supreme-ai-hub
  APP_PORT: 3000
  HOST_PORT: 80
  BIND_IP: 127.0.0.1

jobs:
  validate:
    name: Validate, test, and build
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint --if-present

      - name: Unit tests
        run: npm test --if-present -- --ci

      - name: Build
        run: npm run build --if-present

  containerize:
    name: Build and push image
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name != 'pull_request'
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.vars.outputs.image_tag }}
      image_repo: ${{ steps.vars.outputs.image_repo }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image variables
        id: vars
        run: |
          IMAGE_REPO=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
          echo "image_repo=${IMAGE_REPO}" >> "$GITHUB_OUTPUT"
          echo "image_tag=sha-${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.vars.outputs.image_repo }}
          tags: |
            type=raw,value=${{ steps.vars.outputs.image_tag }}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    name: Deploy to server
    runs-on: ubuntu-latest
    needs: containerize
    if: github.event_name != 'pull_request'
    timeout-minutes: 20
    environment:
      name: production

    steps:
      - name: Validate required secrets are present
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          missing=0
          for name in DEPLOY_HOST DEPLOY_USER DEPLOY_SSH_KEY GHCR_USERNAME GHCR_TOKEN; do
            if [ -z "${!name}" ]; then
              echo "Missing required secret: ${name}" >&2
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Deploy and verify
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_REPO: ${{ needs.containerize.outputs.image_repo }}
          IMAGE_TAG: ${{ needs.containerize.outputs.image_tag }}
          GHCR_USER: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          HEALTHCHECK_URL: ${{ secrets.HEALTHCHECK_URL }}
          DEPLOY_BIND_IP: ${{ secrets.DEPLOY_BIND_IP }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script_stop: true
          envs: IMAGE_REPO,IMAGE_TAG,GHCR_USER,GHCR_TOKEN,HEALTHCHECK_URL,DEPLOY_BIND_IP
          script: |
            set -euxo pipefail
            IMAGE="${{ env.REGISTRY }}/${IMAGE_REPO}:${IMAGE_TAG}"
            HEALTH_URL="${HEALTHCHECK_URL:-http://localhost/health}"
            BIND_IP="${DEPLOY_BIND_IP:-${{ env.BIND_IP }}}"

            printf '%s' "$GHCR_TOKEN" | docker login ${{ env.REGISTRY }} -u "$GHCR_USER" --password-stdin
            docker pull "$IMAGE"

            docker stop "${{ env.CONTAINER_NAME }}" || true
            docker rm "${{ env.CONTAINER_NAME }}" || true

            docker run -d --name "${{ env.CONTAINER_NAME }}" --restart unless-stopped \
              -p ${BIND_IP}:${{ env.HOST_PORT }}:${{ env.APP_PORT }} \
              "$IMAGE"

            for attempt in {1..12}; do
              if curl -fsS "$HEALTH_URL" > /dev/null; then
                echo "Health check passed on attempt ${attempt}"
                docker image prune -f || true
                exit 0
              fi
              sleep 5
            done

            echo "Health check failed for ${HEALTH_URL}" >&2
            docker logs --tail 100 "${{ env.CONTAINER_NAME }}" || true
            exit 1
